{% extends "layouts/base.html" %}
{% load static %}

{% block title %} Email Registration {% endblock %}

{% block body_class %} bg-gray-100 {% endblock %}

{% block content %}

  {% include 'includes/navigation.html' %}

  <header class="header-2">
    <div class="page-header min-vh-75 relative" style="background-image:url('{% static 'assets/img/added-images/analytics.png' %}')">
      <span class="mask bg-gradient-dark"></span>
      <div class="container">
        <div class="row">
          <div class="col-xl-8 col-lg-10 col-md-11 mx-auto">
            <div class="card mt-4 bg-white shadow-lg">
              <div class="card-body p-4">
                <div class="row">
                  <div class="col-md-12">
                    <h4 class="mb-3">Email Tracking Management</h4>
                    
                    <!-- Primary Email -->
                    <div class="mb-4">
                      <h5>Primary Account Email</h5>
                      <p>This is your main account email and cannot be changed here.</p>
                      <input type="text" class="form-control" value="{{ request.user.email }}" disabled>
                    </div>

                    <!-- Tracked Emails -->
                    <div class="mb-4">
                      <h5>Tracked Emails (up to 2)</h5>
                      <p>Manage additional emails for tracking purposes.</p>
                      
                      {% if messages %}
                        {% for message in messages %}
                          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                          </div>
                        {% endfor %}
                      {% endif %}

                      {% if tracked_emails %}
                        <ul class="list-group">
                          {% for tracked_email in tracked_emails %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                              <div>
                                <strong>{{ tracked_email.nickname|default:"No Nickname" }}</strong><br>
                                <small>{{ tracked_email.email }}</small>
                              </div>
                              <div>
                                <button class="btn btn-sm btn-info me-2" data-bs-toggle="modal" data-bs-target="#editEmailModal-{{ tracked_email.id }}">Edit</button>
                                <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#removeEmailModal-{{ tracked_email.id }}">Remove</button>
                              </div>
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <p>You have no tracked emails.</p>
                      {% endif %}
                    </div>

                    <!-- Modals for Edit and Remove -->
                    {% for tracked_email in tracked_emails %}
                    <!-- Edit Email Modal -->
                    <div class="modal fade" id="editEmailModal-{{ tracked_email.id }}" tabindex="-1" aria-labelledby="editEmailModalLabel-{{ tracked_email.id }}" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <form method="post" action="{% url 'email_registration' %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="edit_email">
                            <input type="hidden" name="email_id" value="{{ tracked_email.id }}">
                            <div class="modal-header">
                              <h5 class="modal-title" id="editEmailModalLabel-{{ tracked_email.id }}">Edit Tracked Email</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <div class="mb-3">
                                <label for="email-{{ tracked_email.id }}" class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="email-{{ tracked_email.id }}" name="email" value="{{ tracked_email.email }}" required>
                              </div>
                              <div class="mb-3">
                                <label for="nickname-{{ tracked_email.id }}" class="form-label">Nickname</label>
                                <input type="text" class="form-control" id="nickname-{{ tracked_email.id }}" name="nickname" value="{{ tracked_email.nickname|default:'' }}">
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                              <button type="submit" class="btn btn-primary">Save changes</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>

                    <!-- Remove Email Modal -->
                    <div class="modal fade" id="removeEmailModal-{{ tracked_email.id }}" tabindex="-1" aria-labelledby="removeEmailModalLabel-{{ tracked_email.id }}" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <form method="post" action="{% url 'email_registration' %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="remove_email">
                            <input type="hidden" name="email_id" value="{{ tracked_email.id }}">
                            <div class="modal-header">
                              <h5 class="modal-title" id="removeEmailModalLabel-{{ tracked_email.id }}">Remove Tracked Email</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <p>Are you sure you want to remove this email?
                                <br><strong>{{ tracked_email.email }}</strong>
                              </p>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                              <button type="submit" class="btn btn-danger">Remove</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                    {% endfor %}

                    <!-- Add New Tracked Email Form -->
                    {% if tracked_emails|length < 2 %}
                    <div class="mt-4">
                      <h5>Add a New Email to Track</h5>
                      <form method="post" action="{% url 'email_registration' %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_email">
                        <div class="mb-3">
                          <label for="{{ form.email.id_for_label }}" class="form-label">Email Address</label>
                          {{ form.email }}
                        </div>
                        <div class="mb-3">
                          <label for="{{ form.nickname.id_for_label }}" class="form-label">Nickname (Optional)</label>
                          {{ form.nickname }}
                        </div>
                        <button type="submit" class="btn btn-primary">Add Email</button>
                      </form>
                    </div>
                    {% else %}
                      <p class="text-muted">You have reached the maximum of 2 tracked emails.</p>
                    {% endif %}

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  {% include 'includes/footer-5.html' %}

{% endblock content %}
